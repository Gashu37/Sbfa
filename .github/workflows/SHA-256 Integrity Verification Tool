<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STI-Ethiopia Data Integrity & LLM Analysis Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .card { box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-primary { transition: all 0.2s ease; }
        .btn-primary:hover { background-color: #1a56db; transform: translateY(-1px); }
        .hash-output { word-break: break-all; background-color: #e9ecef; }
        .llm-button { background-color: #9333ea; }
        .llm-button:hover { background-color: #7e22ce; }
    </style>
</head>
<body>
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="card bg-white w-full max-w-4xl p-8 rounded-xl border border-gray-200">
            <h1 class="text-3xl font-extrabold text-[#1f2937] mb-6 border-b pb-3 text-center">
                ğŸ›¡ï¸ STI-Ethiopia: á‹¨áˆªá–áˆ­á‰µ á‹°áˆ…áŠ•áŠá‰µ áŠ¥áŠ“ á‰µáŠ•á‰°áŠ“ áˆ˜áˆ³áˆªá‹«
            </h1>
            <p class="text-sm text-gray-500 mb-6 text-center">
                á‹­áˆ… áˆ˜áˆ³áˆªá‹« SHA-256 HasháŠ• á‰ áˆ˜áŒ á‰€áˆ á‹¨áˆ°áŠá‹µ á‰³áˆ›áŠáŠá‰µáŠ• á‹«áˆ¨áŒ‹áŒáŒ£áˆ áŠ¥áŠ•á‹²áˆáˆ á‹¨Genimi APIáŠ• á‰ áˆ˜áŒ á‰€áˆ á‹¨áˆªá–áˆ­á‰µ á‰µáŠ•á‰°áŠ“ á‹­áˆ°áŒ£áˆá¢
            </p>

            <!-- 1. Report Data Input -->
            <div class="mb-8">
                <label for="reportContent" class="block text-lg font-medium text-gray-700 mb-2">1. á‹¨áˆªá–áˆ­á‰µ á‹­á‹˜á‰µ (Original Data)</label>
                <textarea id="reportContent" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#3b82f6] focus:border-[#3b82f6] transition" placeholder="áŠ¥á‹šáˆ… á‹¨á‹á‹­áŠ“áŠ•áˆµ Resilience Score áˆªá–áˆ­á‰±áŠ• JSON á‹ˆá‹­áˆ Text á‹«áˆµáŒˆá‰¡..."></textarea>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <button onclick="generateHash()" class="btn-primary py-3 bg-[#3b82f6] text-white font-semibold rounded-lg shadow-md hover:shadow-lg">
                        Generate Original Hash (Step 1: Hash ááŒ áˆ­)
                    </button>
                    <button onclick="analyzeReport()" id="analyzeBtn" class="llm-button py-3 text-white font-semibold rounded-lg shadow-md hover:shadow-lg flex items-center justify-center">
                        âœ¨ á‹¨áˆªá–áˆ­á‰µ á‰µáŠ•á‰°áŠ“ áŠ¥áŠ“ áˆ›áŒ á‰ƒáˆˆá‹« (LLM Analyze)
                    </button>
                </div>
            </div>

            <!-- 2. Hash Output -->
            <div class="mb-8 border-b pb-6">
                <label class="block text-lg font-medium text-gray-700 mb-2">á‹¨á‰°áˆáŒ áˆ¨á‹ Hash Value</label>
                <div id="originalHashOutput" class="hash-output p-3 rounded-lg text-sm text-gray-800 h-10 flex items-center">
                    <!-- Hash will appear here -->
                </div>
            </div>

            <!-- 3. LLM Analysis Output -->
            <div class="mb-8 border-b pb-6">
                <h2 class="text-xl font-bold text-gray-700 mb-4">âœ¨ á‹¨Genimi á‰µáŠ•á‰°áŠ“ á‹áŒ¤á‰µ</h2>
                <div id="llmAnalysisOutput" class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-gray-700 min-h-[50px]">
                    á‹áŒ¤á‰± áŠ¥á‹šáˆ… á‹­á‰³á‹«áˆ...
                </div>
            </div>

            <!-- 4. Verification Section -->
            <div class="pt-6">
                <h2 class="text-xl font-bold text-gray-700 mb-4">3. á‹¨á‹­á‹˜á‰µ á‰³áˆ›áŠáŠá‰µáŠ• áˆ›áˆ¨áŒ‹áŒˆáŒ¥ (Integrity Check)</h2>
                
                <label for="savedHash" class="block text-base font-medium text-gray-700 mb-2">Original Hash (áŠ¨Firestore á‹¨á‰°áŒˆáŠ˜)</label>
                <input type="text" id="savedHash" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#10b981] focus:border-[#10b981] transition mb-4" placeholder="á‹¨áˆ˜áŒ€áˆ˜áˆªá‹«á‹áŠ• Hash áŠ¥á‹šáˆ… á‹­áˆˆáŒ¥á‰...">

                <label for="verificationContent" class="block text-base font-medium text-gray-700 mb-2">á‹¨áˆ›áˆ¨áŒ‹áŒˆáŒ« á‹­á‹˜á‰µ (á‰ áŠ‹áˆ‹ á‹¨á‰°áŒá‰°á‰°á‹ á‹³á‰³)</label>
                <textarea id="verificationContent" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#10b981] focus:border-[#10b981] transition" placeholder="áŠ¨Firestore á‹¨á‰°áŒá‰°á‰°á‹áŠ• áŠ á‹²áˆµ á‹¨áˆªá–áˆ­á‰µ á‹­á‹˜á‰µ áŠ¥á‹šáˆ… á‹«áˆµáŒˆá‰¡..."></textarea>

                <button onclick="verifyIntegrity()" class="w-full mt-4 py-3 bg-[#10b981] text-white font-semibold rounded-lg shadow-md hover:bg-[#059669] hover:shadow-lg">
                    Verify Content Integrity (á‰³áˆ›áŠáŠá‰µáŠ• áŠ áˆ¨áŒ‹áŒáŒ¥)
                </button>

                <div id="verificationResult" class="mt-4 p-4 text-center rounded-lg font-bold text-white">
                    <!-- Verification result will appear here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GEMINI API Configuration ---
        const API_KEY = ""; // Canvas will provide this if empty
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        // --- Hash Verification Functions (Unchanged) ---
        function bufferToHex(buffer) {
            return Array.from(new Uint8Array(buffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        async function hashContent(content) {
            const encoder = new TextEncoder();
            const data = encoder.encode(content);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return bufferToHex(hashBuffer);
        }

        async function generateHash() {
            const content = document.getElementById('reportContent').value.trim();
            const outputElement = document.getElementById('originalHashOutput');
            outputElement.textContent = 'Generating Hash...';
            outputElement.classList.remove('bg-red-200', 'bg-green-200');
            outputElement.classList.add('bg-e9ecef');

            if (content.length === 0) {
                outputElement.textContent = 'Error: áŠ¥á‰£áŠ­á‹ á‹¨áˆªá–áˆ­á‰µ á‹­á‹˜á‰µ á‹«áˆµáŒˆá‰¡á¢';
                outputElement.classList.remove('bg-e9ecef');
                outputElement.classList.add('bg-red-200');
                return;
            }

            try {
                const hash = await hashContent(content);
                outputElement.textContent = hash;
            } catch (error) {
                outputElement.textContent = `Hashing Failed: ${error.message}`;
                outputElement.classList.remove('bg-e9ecef');
                outputElement.classList.add('bg-red-200');
            }
        }

        async function verifyIntegrity() {
            const savedHash = document.getElementById('savedHash').value.trim();
            const verificationContent = document.getElementById('verificationContent').value.trim();
            const resultElement = document.getElementById('verificationResult');

            resultElement.classList.remove('bg-red-500', 'bg-green-500');

            if (savedHash.length === 0 || verificationContent.length === 0) {
                resultElement.textContent = 'áŠ¥á‰£áŠ­á‹ áˆáˆˆá‰±áŠ•áˆ Hash áŠ¥áŠ“ á‹­á‹˜á‰µ á‹«áˆµáŒˆá‰¡á¢';
                resultElement.classList.add('bg-red-500');
                return;
            }

            try {
                const newHash = await hashContent(verificationContent);

                if (newHash === savedHash) {
                    resultElement.textContent = 'âœ… á‰³áˆ›áŠáŠá‰µ á‰°áˆ¨áŒ‹áŒáŒ§áˆ! (Integrity Verified) - á‹­á‹˜á‰± áŠ áˆá‰°áŠáŠ«áˆá¢';
                    resultElement.classList.add('bg-green-500');
                } else {
                    resultElement.textContent = 'ğŸš¨ áˆµáˆ…á‰°á‰µ á‰°áŒˆáŠá‰·áˆ! (Integrity Failed) - á‹­á‹˜á‰± á‰°áˆˆá‹áŒ§áˆá¢';
                    resultElement.classList.add('bg-red-500');
                }
            } catch (error) {
                resultElement.textContent = `Verification Failed: ${error.message}`;
                resultElement.classList.add('bg-red-500');
            }
        }

        // --- GEMINI LLM Feature: Report Analysis ---

        /**
         * Implements exponential backoff for API retries.
         * @param {Function} fn - The function to execute.
         * @param {number} maxRetries - Maximum number of retries.
         */
        async function fetchWithRetry(fn, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function analyzeReport() {
            const content = document.getElementById('reportContent').value.trim();
            const outputElement = document.getElementById('llmAnalysisOutput');
            const analyzeBtn = document.getElementById('analyzeBtn');

            outputElement.innerHTML = '<span class="text-purple-600">...Genimi áˆªá–áˆ­á‰±áŠ• áŠ¥á‹¨á‰°áŠá‰°áŠ áŠá‹ (á‰µáŠ•áˆ½ áŒŠá‹œ á‹­á‹ˆáˆµá‹³áˆ)...</span>';
            analyzeBtn.disabled = true;

            if (content.length === 0) {
                outputElement.innerHTML = '<span class="text-red-500">Error: áŠ¥á‰£áŠ­á‹ áˆˆáˆ˜á‰°áŠ•á‰°áŠ• á‹¨áˆªá–áˆ­á‰µ á‹­á‹˜á‰µ á‹«áˆµáŒˆá‰¡á¢</span>';
                analyzeBtn.disabled = false;
                return;
            }

            const systemPrompt = "áŠ áŠ•á‰° á‹¨Small Business Factory Agency áŠ¨áá‰°áŠ› á‹¨á‹á‹­áŠ“áŠ•áˆµ á‰°áŠ•á‰³áŠ áŠáˆ…á¢ á‹‹áŠ“á‹ áŒá‰¥áˆ… á‹¨ Weldiya áˆ›áˆ…á‰ áˆ¨áˆ°á‰¥áŠ• á‹¨áˆ˜á‰‹á‰‹áˆ áŠ á‰…áˆ (Resilience Score) á‹¨áˆšáˆ˜áˆˆáŠ¨á‰µ áˆªá–áˆ­á‰µáŠ• áˆ˜á‰°áŠ•á‰°áŠ• áŠá‹á¢";
            
            const userQuery = `áŠ¨á‹šáˆ… á‰ á‰³á‰½ á‹«áˆˆá‹áŠ• á‹¨á‹á‹­áŠ“áŠ•áˆµ áˆªá–áˆ­á‰µ á‹ˆá‹­áˆ á‹¨á‹áˆ‚á‰¥ áˆ˜á‹‹á‰…áˆ­ á‰°áˆ˜áˆáŠ¨á‰µá¢\n\n1. á‰ áŠ áŠ•á‹µ áŠ áŠ•á‰€áŒ½ á‹áˆµáŒ¥ á‰áˆá áŒáŠá‰¶á‰½áŠ• áŠ¥áŠ“ á‹‹áŠ“á‹áŠ• 'Resilience Score' áˆµáŠ•á‰µ áŠ¥áŠ•á‹°áˆ†áŠ áŒˆáˆá‰°áˆ…/áŠ á‹áŒ¥á‰°áˆ… áŠ áŒ á‰ƒáˆáˆá¢\n2. á‰ áˆªá–áˆ­á‰± á‹áˆµáŒ¥ á‰ á‰°áŒ á‰€áˆ°á‹ áˆ˜áˆ¨áŒƒ áˆ‹á‹­ á‰°áˆ˜áˆµáˆ­á‰°áˆ… áŠ áŠ•á‹µ á‹‹áŠ“ á‹¨á‹á‹­áŠ“áŠ•áˆµ áˆµáŒ‹á‰µ áŠ¥áŠ“ áŠ áŠ•á‹µ á‹¨áŠ á‹°áŒ‹ á‰…áŠáˆ³ (Risk Mitigation) áˆ€áˆ³á‰¥ áŠ á‰…áˆ­á‰¥á¢\n\náˆªá–áˆ­á‰±:\n\n${content}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetchWithRetry(() => fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "á‰µáŠ•á‰°áŠ“á‹ áŠ áˆá‰°áˆ³áŠ«áˆá¢ áŠ¥á‰£áŠ­á‹ á‹­á‹˜á‰±áŠ• á‹«áˆ¨áŒ‹áŒáŒ¡á¢";
                
                // Format the output
                outputElement.innerHTML = `<div class="whitespace-pre-wrap">${text}</div>`;

            } catch (error) {
                console.error("Gemini API Error:", error);
                outputElement.innerHTML = `<span class="text-red-500">API áŒ¥áˆªá‹ áŠ áˆá‰°áˆ³áŠ«áˆá¢ áˆµáˆ…á‰°á‰µ: ${error.message}</span>`;
            } finally {
                analyzeBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
